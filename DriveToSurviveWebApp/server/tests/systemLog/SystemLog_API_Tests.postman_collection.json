{
    "info": {
        "_postman_id": "system-log-essential-tests",
        "name": "SystemLog API — Essential Bug Hunting Tests",
        "description": "ชุดทดสอบ API สำหรับ SystemLog เฉพาะส่วนสำคัญ\n\n✅ GET  — อ่าน log ได้ (Admin only)\n❌ POST — ห้ามสร้างด้วยมือ\n❌ PUT  — ห้ามแก้ไข (พ.ร.บ.คอมพิวเตอร์ ม.26)\n❌ DELETE — ห้ามลบ (เก็บ ≥ 90 วัน)\n\nรวม 13 test cases",
        "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
    },
    "variable": [
        { "key": "baseUrl", "value": "http://localhost:3001/api", "type": "string" },
        { "key": "adminEmail", "value": "admin@example.com", "type": "string" },
        { "key": "adminPassword", "value": "adminpassword", "type": "string" },
        { "key": "adminToken", "value": "", "type": "string" },
        { "key": "adminId", "value": "", "type": "string" },
        { "key": "firstLogId", "value": "", "type": "string" },
        { "key": "logCountBefore", "value": "", "type": "string" }
    ],
    "item": [
        {
            "name": "1. Setup — Login Admin",
            "item": [
                {
                    "name": "1.1 Login Admin (รับ Token)",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะต้องเป็น 200 OK', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "var jsonData = pm.response.json();",
                                    "",
                                    "pm.test('ต้องได้รับ token กลับมา', function () {",
                                    "    var token = (jsonData.data && jsonData.data.token) || jsonData.token;",
                                    "    pm.expect(token).to.be.a('string').and.not.empty;",
                                    "    pm.collectionVariables.set('adminToken', token);",
                                    "});",
                                    "",
                                    "var user = (jsonData.data && jsonData.data.user) || jsonData.user;",
                                    "if (user && user.id) {",
                                    "    pm.collectionVariables.set('adminId', user.id);",
                                    "}"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"email\": \"{{adminEmail}}\",\n    \"password\": \"{{adminPassword}}\"\n}",
                            "options": { "raw": { "language": "json" } }
                        },
                        "url": {
                            "raw": "{{baseUrl}}/auth/login",
                            "host": ["{{baseUrl}}"],
                            "path": ["auth", "login"]
                        }
                    }
                }
            ]
        },
        {
            "name": "2. GET — ดึงข้อมูล Logs",
            "item": [
                {
                    "name": "2.1 Admin ดึง Logs ทั้งหมด + ตรวจ pagination type",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะต้องเป็น 200 OK', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "var jsonData = pm.response.json();",
                                    "",
                                    "pm.test('success=true, data เป็น Array, มี pagination', function () {",
                                    "    pm.expect(jsonData.success).to.eql(true);",
                                    "    pm.expect(jsonData.data).to.be.an('array');",
                                    "    pm.expect(jsonData.pagination).to.have.all.keys('page','limit','total','totalPages');",
                                    "});",
                                    "",
                                    "pm.test('ควรมี Log อย่างน้อย 1 รายการ', function () {",
                                    "    pm.expect(jsonData.data.length).to.be.above(0);",
                                    "});",
                                    "",
                                    "if (jsonData.data.length > 0) {",
                                    "    pm.collectionVariables.set('firstLogId', jsonData.data[0].id);",
                                    "    pm.collectionVariables.set('logCountBefore', jsonData.pagination.total);",
                                    "}",
                                    "",
                                    "pm.test('[BUG] pagination.page/limit ต้องเป็น number', function () {",
                                    "    pm.expect(typeof jsonData.pagination.page).to.eql('number');",
                                    "    pm.expect(typeof jsonData.pagination.limit).to.eql('number');",
                                    "});",
                                    "",
                                    "pm.test('[BUG] totalPages ต้องไม่เป็น NaN', function () {",
                                    "    pm.expect(Number.isFinite(jsonData.pagination.totalPages)).to.eql(true);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{adminToken}}", "type": "string" }] },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/system-logs",
                            "host": ["{{baseUrl}}"],
                            "path": ["system-logs"]
                        }
                    }
                },
                {
                    "name": "2.2 Pagination — limit=5 ต้องได้ไม่เกิน 5",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะ 200 + pagination ถูกต้อง', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "    var j = pm.response.json();",
                                    "    pm.expect(j.pagination.limit).to.eql(5);",
                                    "    pm.expect(j.pagination.page).to.eql(1);",
                                    "    pm.expect(j.data.length).to.be.at.most(5);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{adminToken}}", "type": "string" }] },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/system-logs?page=1&limit=5",
                            "host": ["{{baseUrl}}"],
                            "path": ["system-logs"],
                            "query": [
                                { "key": "page", "value": "1" },
                                { "key": "limit", "value": "5" }
                            ]
                        }
                    }
                },
                {
                    "name": "2.3 Filter — userId ต้องได้เฉพาะ user นั้น",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะ 200 + filter userId ถูกต้อง', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "    var j = pm.response.json();",
                                    "    var adminId = pm.collectionVariables.get('adminId');",
                                    "    if (j.data.length > 0 && adminId) {",
                                    "        j.data.forEach(function(log) {",
                                    "            pm.expect(log.userId).to.eql(adminId);",
                                    "        });",
                                    "    }",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{adminToken}}", "type": "string" }] },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/system-logs?userId={{adminId}}",
                            "host": ["{{baseUrl}}"],
                            "path": ["system-logs"],
                            "query": [{ "key": "userId", "value": "{{adminId}}" }]
                        }
                    }
                },
                {
                    "name": "2.4 Filter — action=POST ต้องได้เฉพาะ POST",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะ 200 + filter action ถูกต้อง', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "    var j = pm.response.json();",
                                    "    if (j.data.length > 0) {",
                                    "        j.data.forEach(function(log) {",
                                    "            pm.expect(log.action).to.eql('POST');",
                                    "        });",
                                    "    }",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{adminToken}}", "type": "string" }] },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/system-logs?action=POST",
                            "host": ["{{baseUrl}}"],
                            "path": ["system-logs"],
                            "query": [{ "key": "action", "value": "POST" }]
                        }
                    }
                }
            ]
        },
        {
            "name": "3. Validation — Input ผิดต้อง 400",
            "item": [
                {
                    "name": "3.1 page=0 ต้อง 400",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะต้องเป็น 400', function () {",
                                    "    pm.response.to.have.status(400);",
                                    "    pm.expect(pm.response.json().success).to.eql(false);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{adminToken}}", "type": "string" }] },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/system-logs?page=0",
                            "host": ["{{baseUrl}}"],
                            "path": ["system-logs"],
                            "query": [{ "key": "page", "value": "0" }]
                        }
                    }
                },
                {
                    "name": "3.2 limit=150 (เกิน max 100) ต้อง 400",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะต้องเป็น 400', function () {",
                                    "    pm.response.to.have.status(400);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{adminToken}}", "type": "string" }] },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/system-logs?limit=150",
                            "host": ["{{baseUrl}}"],
                            "path": ["system-logs"],
                            "query": [{ "key": "limit", "value": "150" }]
                        }
                    }
                },
                {
                    "name": "3.3 action=INVALID ต้อง 400",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะต้องเป็น 400', function () {",
                                    "    pm.response.to.have.status(400);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{adminToken}}", "type": "string" }] },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/system-logs?action=INVALID_ACTION",
                            "host": ["{{baseUrl}}"],
                            "path": ["system-logs"],
                            "query": [{ "key": "action", "value": "INVALID_ACTION" }]
                        }
                    }
                }
            ]
        },
        {
            "name": "4. POST — ห้ามสร้าง Log ด้วยมือ",
            "item": [
                {
                    "name": "4.1 POST /system-logs ต้องถูกปฏิเสธ",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('[BUG] POST ต้องไม่สำเร็จ (404/405)', function () {",
                                    "    pm.expect(pm.response.code).to.be.oneOf([404, 405]);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{adminToken}}", "type": "string" }] },
                        "method": "POST",
                        "header": [],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"userId\": \"hacker\",\n    \"action\": \"GET\",\n    \"resource\": \"/api/fake\",\n    \"ipAddress\": \"666.666.666.666\"\n}",
                            "options": { "raw": { "language": "json" } }
                        },
                        "url": {
                            "raw": "{{baseUrl}}/system-logs",
                            "host": ["{{baseUrl}}"],
                            "path": ["system-logs"]
                        }
                    }
                }
            ]
        },
        {
            "name": "5. PUT — ห้ามแก้ไข Log",
            "item": [
                {
                    "name": "5.1 PUT /system-logs/:id ต้องถูกปฏิเสธ",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('[BUG] PUT ต้องไม่สำเร็จ (404/405)', function () {",
                                    "    pm.expect(pm.response.code).to.be.oneOf([404, 405]);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{adminToken}}", "type": "string" }] },
                        "method": "PUT",
                        "header": [],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"action\": \"HACKED\",\n    \"ipAddress\": \"0.0.0.0\"\n}",
                            "options": { "raw": { "language": "json" } }
                        },
                        "url": {
                            "raw": "{{baseUrl}}/system-logs/{{firstLogId}}",
                            "host": ["{{baseUrl}}"],
                            "path": ["system-logs", "{{firstLogId}}"]
                        }
                    }
                }
            ]
        },
        {
            "name": "6. DELETE — ห้ามลบ Log (พ.ร.บ.คอมพิวเตอร์)",
            "item": [
                {
                    "name": "6.1 DELETE /system-logs/:id ต้องถูกปฏิเสธ",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('[BUG] DELETE ต้องไม่สำเร็จ (404/405)', function () {",
                                    "    pm.expect(pm.response.code).to.be.oneOf([404, 405]);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{adminToken}}", "type": "string" }] },
                        "method": "DELETE",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/system-logs/{{firstLogId}}",
                            "host": ["{{baseUrl}}"],
                            "path": ["system-logs", "{{firstLogId}}"]
                        }
                    }
                }
            ]
        },
        {
            "name": "7. Access Control — สิทธิ์",
            "item": [
                {
                    "name": "7.1 ไม่ส่ง Token ต้อง 401",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะต้องเป็น 401 Unauthorized', function () {",
                                    "    pm.response.to.have.status(401);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": { "type": "noauth" },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/system-logs",
                            "host": ["{{baseUrl}}"],
                            "path": ["system-logs"]
                        }
                    }
                },
                {
                    "name": "7.2 Token ปลอม ต้อง 401",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะต้องเป็น 401 Unauthorized', function () {",
                                    "    pm.response.to.have.status(401);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "fake.invalid.token", "type": "string" }] },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/system-logs",
                            "host": ["{{baseUrl}}"],
                            "path": ["system-logs"]
                        }
                    }
                }
            ]
        },
        {
            "name": "8. Data Integrity — ข้อมูลต้องไม่เปลี่ยน",
            "item": [
                {
                    "name": "8.1 จำนวน Log ต้องไม่ลดลงหลังพยายาม DELETE",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะต้องเป็น 200 OK', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "var jsonData = pm.response.json();",
                                    "var before = parseInt(pm.collectionVariables.get('logCountBefore'));",
                                    "",
                                    "pm.test('[BUG] จำนวน Log ต้องไม่ลดลง (Immutable)', function () {",
                                    "    pm.expect(jsonData.pagination.total).to.be.at.least(before);",
                                    "});",
                                    "",
                                    "pm.test('[BUG] Response ต้องไม่มี password/secret', function () {",
                                    "    var text = pm.response.text().toLowerCase();",
                                    "    pm.expect(text).to.not.include('password');",
                                    "    pm.expect(text).to.not.include('jwt_secret');",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{adminToken}}", "type": "string" }] },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/system-logs",
                            "host": ["{{baseUrl}}"],
                            "path": ["system-logs"]
                        }
                    }
                }
            ]
        }
    ]
}