{
    "info": {
        "_postman_id": "blacklist-api-tests",
        "name": "Blacklist API Tests",
        "description": "ชุดทดสอบ API สำหรับจัดการ Blacklist\n\n✅ POST /blacklist — แอดมินเพิ่มเลขบัตรประชาชนใน Blacklist\n✅ GET /blacklist — แอดมินดูรายชื่อ Blacklist ทั้งหมด\n✅ POST /blacklist/check — ตรวจสอบว่าติด Blacklist หรือไม่\n❌ Security — ป้องกันการเข้าถึงโดยไม่ได้รับอนุญาต",
        "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
    },
    "variable": [
        {
            "key": "baseUrl",
            "value": "http://localhost:3001/api",
            "type": "string"
        },
        {
            "key": "adminEmail",
            "value": "admin@example.com",
            "type": "string"
        },
        {
            "key": "adminPassword",
            "value": "adminpassword",
            "type": "string"
        },
        {
            "key": "adminToken",
            "value": "",
            "type": "string"
        },
        {
            "key": "testNationalId",
            "value": "",
            "type": "string"
        },
        {
            "key": "blacklistId",
            "value": "",
            "type": "string"
        }
    ],
    "item": [
        {
            "name": "1. เริ่มต้น — เข้าสู่ระบบแอดมิน",
            "item": [
                {
                    "name": "1.1 ล็อกอินแอดมิน (รับ Token)",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะตอบกลับต้องเป็น 200', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "var jsonData = pm.response.json();",
                                    "pm.test('ได้รับ Token', function () {",
                                    "    pm.expect(jsonData.data.token).to.be.a('string');",
                                    "    pm.collectionVariables.set('adminToken', jsonData.data.token);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        },
                        {
                            "listen": "prerequest",
                            "script": {
                                "exec": [
                                    "// สร้างเลขบัตรประชาชนแบบสุ่ม (13 หลัก) จากเวลาปัจจุบัน",
                                    "var timestamp = new Date().getTime().toString();",
                                    "// ตรวจสอบความยาว ถ้าไม่ครบ 13 ให้เติม 0",
                                    "while (timestamp.length < 13) {",
                                    "    timestamp += '0';",
                                    "}",
                                    "// ถ้าเกิน 13 (อนาคต) ตัดให้เหลือ 13",
                                    "if (timestamp.length > 13) {",
                                    "    timestamp = timestamp.substring(0, 13);",
                                    "}",
                                    "pm.collectionVariables.set('testNationalId', timestamp);",
                                    "console.log('Generated National ID:', timestamp);"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"email\": \"{{adminEmail}}\",\n    \"password\": \"{{adminPassword}}\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{baseUrl}}/auth/login",
                            "host": [
                                "{{baseUrl}}"
                            ],
                            "path": [
                                "auth",
                                "login"
                            ]
                        }
                    }
                }
            ]
        },
        {
            "name": "2. POST — เพิ่มคนเข้า Blacklist",
            "item": [
                {
                    "name": "2.1 เพิ่มเลขบัตรประชาชนเข้า Blacklist (สำเร็จ)",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะตอบกลับต้องเป็น 201 Created', function () {",
                                    "    pm.response.to.have.status(201);",
                                    "});",
                                    "",
                                    "var jsonData = pm.response.json();",
                                    "pm.test('Success ต้องเป็น true', function () {",
                                    "    pm.expect(jsonData.success).to.eql(true);",
                                    "});",
                                    "",
                                    "if (jsonData.data && jsonData.data.id) {",
                                    "    pm.collectionVariables.set('blacklistId', jsonData.data.id);",
                                    "}"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{adminToken}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "POST",
                        "header": [],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"nationalId\": \"{{testNationalId}}\",\n    \"reason\": \"พบพฤติกรรมทุจริต (ทดสอบระบบ)\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{baseUrl}}/blacklist",
                            "host": [
                                "{{baseUrl}}"
                            ],
                            "path": [
                                "blacklist"
                            ]
                        }
                    }
                },
                {
                    "name": "2.2 เพิ่มเลขบัตรซ้ำ (ต้องไม่สำเร็จ)",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะตอบกลับต้องเป็น 409 Conflict', function () {",
                                    "    pm.response.to.have.status(409);",
                                    "});",
                                    "pm.test('ข้อความผิดพลาดถูกต้อง', function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData.message).to.include('already in the blacklist');",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{adminToken}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "POST",
                        "header": [],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"nationalId\": \"{{testNationalId}}\",\n    \"reason\": \"พยายามเพิ่มซ้ำ\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{baseUrl}}/blacklist",
                            "host": [
                                "{{baseUrl}}"
                            ],
                            "path": [
                                "blacklist"
                            ]
                        }
                    }
                },
                {
                    "name": "2.3 ตรวจสอบว่าติด Blacklist หรือไม่ (Check)",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะตอบกลับต้องเป็น 200 OK', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "var jsonData = pm.response.json();",
                                    "pm.test('isBlacklisted ต้องเป็น true', function () {",
                                    "    pm.expect(jsonData.isBlacklisted).to.be.true;",
                                    "});",
                                    "",
                                    "pm.test('ต้องได้รับข้อมูลเหตุผล', function () {",
                                    "    pm.expect(jsonData.data).to.have.property('reason');",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{adminToken}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "POST",
                        "header": [],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"nationalId\": \"{{testNationalId}}\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{baseUrl}}/blacklist/check",
                            "host": [
                                "{{baseUrl}}"
                            ],
                            "path": [
                                "blacklist",
                                "check"
                            ]
                        }
                    }
                }
            ]
        },
        {
            "name": "3. GET — ดูรายชื่อ Blacklist",
            "item": [
                {
                    "name": "3.1 ดูรายชื่อทั้งหมด (แอดมิน)",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะตอบกลับต้องเป็น 200 OK', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "var jsonData = pm.response.json();",
                                    "pm.test('ข้อมูลต้องเป็น Array', function () {",
                                    "    pm.expect(jsonData.data).to.be.an('array');",
                                    "});",
                                    "",
                                    "pm.test('ต้องมี Hash และเหตุผล', function () {",
                                    "    // ตรวจสอบว่ามีข้อมูลอย่างน้อย 1 รายการและมีฟิลด์ที่ถูกต้อง",
                                    "    if(jsonData.data.length > 0) {",
                                    "       pm.expect(jsonData.data[0]).to.have.property('nationalIdHash');",
                                    "       pm.expect(jsonData.data[0]).to.have.property('reason');",
                                    "    }",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{adminToken}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/blacklist",
                            "host": [
                                "{{baseUrl}}"
                            ],
                            "path": [
                                "blacklist"
                            ]
                        }
                    }
                },
                {
                    "name": "3.2 ทดสอบการแบ่งหน้า (Pagination)",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะตอบกลับต้องเป็น 200', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "var jsonData = pm.response.json();",
                                    "pm.test('Limit การแบ่งหน้าถูกต้อง', function () {",
                                    "    pm.expect(jsonData.pagination.limit).to.eql(5);",
                                    "    pm.expect(jsonData.data.length).to.be.at.most(5);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{adminToken}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/blacklist?limit=5",
                            "host": [
                                "{{baseUrl}}"
                            ],
                            "path": [
                                "blacklist"
                            ],
                            "query": [
                                {
                                    "key": "limit",
                                    "value": "5"
                                }
                            ]
                        }
                    }
                }
            ]
        },
        {
            "name": "4. Security — การเข้าถึงโดยไม่ได้รับอนุญาต",
            "item": [
                {
                    "name": "4.1 ไม่ส่ง Token (ต้องได้ 401)",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะตอบกลับต้องเป็น 401 Unauthorized', function () {",
                                    "    pm.response.to.have.status(401);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/blacklist",
                            "host": [
                                "{{baseUrl}}"
                            ],
                            "path": [
                                "blacklist"
                            ]
                        }
                    }
                },
                {
                    "name": "4.2 Token ไม่ถูกต้อง (ต้องได้ 401)",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะตอบกลับต้องเป็น 401 Unauthorized', function () {",
                                    "    pm.response.to.have.status(401);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "fake.token",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/blacklist",
                            "host": [
                                "{{baseUrl}}"
                            ],
                            "path": [
                                "blacklist"
                            ]
                        }
                    }
                }
            ]
        },
        {
            "name": "5. DELETE — ล้างข้อมูล",
            "item": [
                {
                    "name": "5.1 ลบคนออกจาก Blacklist",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('สถานะตอบกลับต้องเป็น 200 OK', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{adminToken}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "DELETE",
                        "header": [],
                        "url": {
                            "raw": "{{baseUrl}}/blacklist/{{blacklistId}}",
                            "host": [
                                "{{baseUrl}}"
                            ],
                            "path": [
                                "blacklist",
                                "{{blacklistId}}"
                            ]
                        }
                    }
                }
            ]
        }
    ]
}